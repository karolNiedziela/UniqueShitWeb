@if (profileState$ | async; as state) {
  <div class="profile-container">

    @if (state.isLoading) {
      <div class="loading-spinner">
        <p>Loading profile...</p>
      </div>
    }

    @if (state.error) {
      <div class="error-message">
        <p>{{ state.error }}</p>
      </div>
    }

    @if (state.user; as u) {
      
      @if (!editMode) {
        <div class="profile-header">
          <h1>User profile: {{ u.displayName }}</h1>
          
          <div class="header-actions">
            <button mat-stroked-button color="accent" [routerLink]="['/profile', u.displayName, 'sale-offers']">
              Sale offers
            </button>
            <button mat-stroked-button color="accent" [routerLink]="['/profile', u.displayName, 'purchase-offers']">
              Purchase offers
            </button>

            @if (!state.isOwnProfile) {
              <button mat-flat-button color="primary" (click)="chatService.startChat(u.id, u.displayName)">
                Start Chat
              </button>
            }

            @if (state.isOwnProfile) {
              <button mat-stroked-button color="primary" (click)="toggleEditMode()">Edit Profile</button>
            }
          </div>
        </div>

        <div class="profile-details">
          <p><strong>Telephone:</strong> {{ u.phoneNumber || 'Not specified' }}</p>
          <p><strong>City:</strong> {{ u.city || 'Not specified' }}</p>
          <p><strong>About me:</strong></p>
          <blockquote class="about-me">{{ u.aboutMe || 'No description.' }}</blockquote>
        </div>
      } 
      
      @else if (editMode && state.isOwnProfile) {
        <div class="profile-header">
          <h1>Edit your profile</h1>
        </div>

        <form [formGroup]="editForm" (ngSubmit)="saveChanges(u)">
          <div class="form-field">
            <label for="phoneNumber">Telephone:</label>
            <input id="phoneNumber" formControlName="phoneNumber" />
          </div>
          <div class="form-field">
            <label for="city">City:</label>
            <input id="city" formControlName="city" />
          </div>

          <div class="form-field">
            <app-text-area
              formControlName="aboutMe"
              [label]="'About me:'"
              [maxLength]="512"
              [rows]="8">
            </app-text-area>
            @if (editForm.get('aboutMe')?.hasError('maxlength')) {
              <div class="form-error">The description fits max 512 characters.</div>
            }
          </div>

          <div class="form-actions">
            <button mat-flat-button color="primary" type="submit" [disabled]="editForm.invalid || isSaving">
              {{ isSaving ? 'Saving...' : 'Save' }}
            </button>
            <button mat-stroked-button type="button" (click)="toggleEditMode()">
              Cancel
            </button>
          </div>
        </form>
      }
    }
  </div>
}
<app-opened-chats
  [openedChats]="chatService.openedChats()"
  (closeChat)="chatService.removeChat($event)"
></app-opened-chats>